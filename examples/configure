#!/usr/bin/env python3

import os

S_IFMT = 0o170000
S_IFDIR = 0o040000

if __name__ == "__main__":
    entries = os.listdir('.')
    exclude_dirs = ['Release', 'snap-examples.xcodeproj', 'pbfs', 'XcodeTest', 'motifcluster', 'zygote']
    dirs = []
    for entry in entries:
        st = os.stat(entry)
        if st.st_mode & S_IFMT == S_IFDIR:
            if entry not in exclude_dirs:
                dirs.append(entry)

    with open('src.mk', 'w') as fobj:
        fobj.write("SUB_DIRS = \\\n")
        for entry in dirs:
            fobj.write(f'\t{entry} \\\n')
        
        # target_agmfit: 
        #   $(MAKE) -C agmfit
        # clean_agmfit: 
        #   $(MAKE) clean -C agmfit

        for entry in dirs:
            fobj.write(f'\ntarget_{entry}:\n')
            fobj.write(f'\t$(MAKE) -C {entry}\n')
            fobj.write(f'\nclean_{entry}:\n')
            fobj.write(f'\t$(MAKE) clean -C {entry}\n')

        # all_depends: dir1 dir2 ...
        fobj.write('\nall_depends = \\\n')
        for entry in dirs:
            fobj.write(f'\ttarget_{entry} \\\n')

        fobj.write('\nclean_all_depends = \\\n')
        for entry in dirs:
            fobj.write(f'\tclean_{entry} \\\n')

        fobj.write('\n.PHONY: $(all_depends) $(clean_all_depends)\n\n')

